@page "/add/{Username}"


@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject NavigationManager navigationManager
@inject IStringLocalizer<Resource> Localizer

@inject UserService UserService

<MudPopoverProvider />

<style>
    .center-form {
    display: flex; /* Enables Flexbox */
    align-items: center; /* Centers content vertically */
    height: 80vh; /* Full viewport height */
    }
    .center {
    display: flex;
    justify-content: center;
    }

</style>

<MudGrid Justify="Justify.Center" Class="center-form">
    <MudItem xs="12" sm="6" md="6" lg="4" xxl="2">
        <BoardForm Board="board" OnSubmit="HandleConfirm" />
    </MudItem>
</MudGrid>

@code {
    [Parameter]
    public string Username { get; set; } = string.Empty;

    private Board board = new Board();
    private User? user;
    protected override async Task OnInitializedAsync()
    {
        user = await UserService.GetUserAsync(Username);
        if (user is null)
        {
            navigationManager.NavigateTo("/home");
        }
    }

    /// <summary>
    /// Handles confirmation of the input form
    /// </summary>
    private async Task HandleConfirm()
    {
        if (user!.Boards is null)
        {
            board.Order = 0;
            user.Boards = new() { board };
        }
        else
        {
            if(user.Boards.Count == 0)
            {
                board.Order = 0;
            }
            else
            {
                board.Order = user.Boards.Max(board => board.Order) + 1;
            }
            user.Boards.Add(board);
        }
        board.User = user; 
        UserService.AddBoard(board);
        navigationManager.NavigateTo($"/{Username}");
    }
}